
# 创建调用宏的自定义菜单

下面的代码示例演示的如何创建自定义菜单含有四个菜单选项，其中的每个调用宏。

 **示例提供的代码:** 神圣的宏!书中，[神圣宏!它是 2500 Excel VBA 示例](http://www.mrexcel.com/store/index.php?l=product_detail&amp;p=1)

下面的代码示例设置自定义菜单上，当工作簿打开时，以及在关闭工作簿时将其删除。




```
Option Explicit

Private Sub Workbook_BeforeClose(Cancel As Boolean)
   With Application.CommandBars("Worksheet Menu Bar")
      On Error Resume Next
      .Controls("&amp;MyFunction").Delete
      On Error GoTo 0
   End With
End Sub

Private Sub Workbook_Open()
   Dim objPopUp As CommandBarPopup
   Dim objBtn As CommandBarButton
   With Application.CommandBars("Worksheet Menu Bar")
      On Error Resume Next
      .Controls("MyFunction").Delete
      On Error GoTo 0
      Set objPopUp = .Controls.Add( _
         Type:=msoControlPopup, _
         before:=.Controls.Count, _
         temporary:=True)
   End With
   objPopUp.Caption = "&amp;MyFunction"
   Set objBtn = objPopUp.Controls.Add
   With objBtn
      .Caption = "Formula Entry"
      .OnAction = "Cbm_Active_Formula"
      .Style = msoButtonCaption
   End With
   Set objBtn = objPopUp.Controls.Add
   With objBtn
      .Caption = "Value Entry"
      .OnAction = "Cbm_Active_Value"
      .Style = msoButtonCaption
   End With
   Set objBtn = objPopUp.Controls.Add
   With objBtn
      .Caption = "Formula Selection"
      .OnAction = "Cbm_Formula_Select"
      .Style = msoButtonCaption
   End With
   Set objBtn = objPopUp.Controls.Add
   With objBtn
      .Caption = "Value Selection"
      .OnAction = "Cbm_Value_Select"
      .Style = msoButtonCaption
   End With
End Sub
```

"MyFunction"时将工作簿打开时，被添加的菜单和工作簿关闭时删除。它提供四个菜单选项，使用分配给每个选项的宏。用户定义函数 (UDF)"MyFunction"一起将区域中的三个值相乘并返回结果。



```
Function MyFunction(rng As Range) As Double
   MyFunction = rng(1) * rng(2) * rng(3)
End Function
```

 **输入公式:** 此菜单选项被指定宏"Cbm_Active_Formula"，调用该 UDF，名为"MyFunction"，将前面的 3 单元格中的数字相乘并将 UDF 值存储到活动单元格。单击此菜单选项之前，必须有区域 B6:D6 中的值并选择单元格 E6。



```
Sub Cbm_Active_Formula()
   'setting up the variables.
   Dim intLen As Integer, strRng As String
   
   'Using the active cell, E6.
   With ActiveCell
      'Check to see if the preceding offset has valid data, and if there are three values
      If IsEmpty(.Offset(0, -1)) Or .Column < 4 Then
         
          'If the data is not valid, call MyFunction directly as a formula, but with no parameters.
         .Formula = "=MyFunction()"
          Application.SendKeys "{ENTER}"
      Else
      
         'If the data is valid, create a range of the preceding 3 cells
         strRng = Range(Cells(.Row, .Column - 3), _
            Cells(.Row, .Column - 1)).Address
         intLen = Len(strRng)
         
         'Call MyFunction as a formula, with the range as the parameter.
         .Formula = "=MyFunction(" &amp; strRng &amp; ")"
            Application.SendKeys "{ENTER}"
      End If
   End With
End Sub
```

 **值项目:** 此菜单选项被指定宏"Cbm_Active_Value"，输入生成 UDF 名"MyFunction"为活动单元格中的值。单击此菜单选项之前，必须有区域 B6:D6 中的值并选择单元格 E6。



```
Sub Cbm_Active_Value()
   'Set up the variables.
   Dim intLen As Integer, strRng As String
   
   'Using the active cell, E6.
   With ActiveCell
      'If there isn't enough room in the column, then send a warning.
      If .Column < 4 Then
         Beep
         MsgBox "The function can be used only starting from column D!"
      
      'Otherwise, call MyFunction, using the range of the previous 3 cells.
      Else
         ActiveCell.Value = MyFunction(Range(ActiveCell.Offset(0, -3), _
            ActiveCell.Offset(0, -1)))
      End If
   End With
End Sub
```

 **公式的选择:** 此菜单选项被指定宏"Cbm_Formula_Select"，使用 InputBox 用户选择"MyFunction"UDF 应该计算的范围。UDF 的返回值存储在活动单元格。



```
Sub Cbm_Formula_Select()
   'Set up the variables.
   Dim rng As Range
   
   'Use the InputBox dialog to set the range for MyFunction, with some simple error handling.
   Set rng = Application.InputBox("Range:", Type:=8)
   If rng.Cells.Count <> 3 Then
      MsgBox "Length, width and height are needed -" &amp; _
         vbLf &amp; "please select three cells!"
      Exit Sub
   End If
   'Call MyFunction in the active cell, E6.
   ActiveCell.Formula = "=MyFunction(" &amp; rng.Address &amp; ")"
End Sub
```

 **值选择:** 此菜单选项被指定宏"Cbm_Value_Select"，为用户选择"MyFunction"UDF 应该计算范围中使用 InputBox。值存储在活动单元格直接，而不通过 UDF 返回。



```
Sub Cbm_Value_Select()
   'Set up the variables.
   Dim rng As Range
   
   'Use the InputBox dialog to set the range for MyFunction, with some simple error handling.
   Set rng = Application.InputBox("Range:", Type:=8)
   If rng.Cells.Count <> 3 Then
     MsgBox "Length, width and height are needed -" &amp; _
         vbLf &amp; "please select three cells!"
      Exit Sub
   End If
   
   'Call MyFunction by value using the active cell, E6.
   ActiveCell.Value = MyFunction(rng)
End Sub
```


## 有关参与者
<a name="AboutContributor"> </a>

Holy Macro! Books 主要出版娱乐书籍，供使用 Microsoft Office 的人员阅读。单击 MrExcel.com，查看完整的目录。

